## Storie - Optimized configuration for minimal binary size
## Applies to both native and web (WASM) builds

# Memory management - ARC is more efficient than default GC
--mm:arc

# Optimization - prioritize size over speed
--define:release
--opt:size

# Exception handling - panics are smaller than full exceptions
--panics:on

# Dead code elimination - remove unused code
--deadCodeElim:on

# Link-time optimization for smaller binaries (native builds)
--passC:"-flto"
--passL:"-flto"

# Strip debug symbols (major size reduction for native)
--passL:"-s"

# Disable signal handlers (not needed, reduces size)
--define:noSignalHandler

# Threading - keep off for web compatibility
--threads:off

# Exception handling mode for WASM
--exceptions:goto

## Emscripten/WebAssembly specific configuration
@if emscripten:
  --os:linux
  --cpu:wasm32
  --cc:clang
  --clang.exe:emcc
  --clang.linkerexe:emcc
  --clang.cpp.exe:emcc
  --clang.cpp.linkerexe:emcc
  
  # Aggressive size optimization for Emscripten
  --passC:"-Oz"
  --passL:"-Oz"
  
  # Google Closure Compiler for additional JS minification
  --passL:"--closure=1"
  --passL:"-sIGNORE_CLOSURE_COMPILER_ERRORS=1"
  
  # Basic Emscripten settings
  --passL:"-sWASM=1"
  --passL:"-sASSERTIONS=0"
  --passL:"-sALLOW_MEMORY_GROWTH=1"
  --passL:"-sINITIAL_MEMORY=67108864"
  --passL:"-sSTACK_SIZE=8388608"
  --passL:"-sENVIRONMENT=web"
  --passL:"-sMODULARIZE=0"
  --passL:"-sEXPORT_NAME='Module'"
  
  # Export common runtime methods
  --passL:"-sEXPORTED_RUNTIME_METHODS=['ccall','cwrap','UTF8ToString','FS']"
  
  # Additional size optimizations
  --passL:"-sELIMINATE_DUPLICATE_FUNCTIONS=1"
  --passL:"-sMINIMAL_RUNTIME=0"
  
  # Note: MINIMAL_RUNTIME=1 would save more but breaks some features
  # You can enable it if you don't need full runtime features
@end

## SDL3 backend specific settings
@if sdl3:
  @if emscripten:
    --passL:"-sUSE_SDL=3"
    --passL:"-sUSE_WEBGL2=1"
    --passL:"-sFULL_ES3=1"
  @end
@end

## Development override
## To build in debug mode, use: nim c -d:debug
@if debug:
  # Disable all optimizations for debugging
  --opt:none
  --debugger:native
  --stackTrace:on
  --lineTrace:on
  # Re-enable assertions for debugging
  @if emscripten:
    --passL:"-sASSERTIONS=2"
    --passL:"--closure=0"
  @end
@else:
  # Production: disable stack traces for smaller binaries
  --stackTrace:off
  --lineTrace:off
@end
