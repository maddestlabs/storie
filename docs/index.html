<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storie SDL3</title>
    <style>
        @font-face {
            font-family: 'AnomalyMono';
            src: url('assets/AnomalyMono-Powerline.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
    </style>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: monospace;
            color: #fff;
            overflow: hidden;
        }
        #container {
            position: relative;
            text-align: center;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #canvas {
            border: 1px solid #333;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            display: block;
            max-width: 100%;
            max-height: calc(100vh - 40px);
            width: auto;
            height: auto;
            object-fit: contain;
        }
        #status {
            margin-top: 10px;
            font-size: 12px;
            color: #888;
            position: absolute;
            bottom: 10px;
        }
        .error {
            color: #f44;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas" width="800" height="600"></canvas>
        <div id="status">Loading...</div>
    </div>
    
    <script>
        // Check for ?gist= URL parameter BEFORE loading WASM
        const urlParams = new URLSearchParams(window.location.search);
        const gistId = urlParams.get('gist');
        let gistMarkdown = null;
        let moduleReady = false;
        let gistReady = false;
        
        // If gist is present, we need to tell WASM not to load default markdown
        if (gistId) {
            console.log('Gist parameter detected:', gistId);
        }
        
        function tryLoadGist() {
            // Only load if both module and gist are ready
            console.log('tryLoadGist called - moduleReady:', moduleReady, 'gistReady:', gistReady, 'hasMarkdown:', !!gistMarkdown);
            
            if (moduleReady && gistReady && gistMarkdown) {
                console.log('=== Loading markdown from gist (' + gistMarkdown.length + ' bytes) ===');
                try {
                    // Call the exported C function
                    // Note: ccall with 'string' type handles memory allocation automatically
                    if (typeof Module.ccall === 'function') {
                        // Add null terminator and use proper string handling
                        var result = Module.ccall(
                            'loadMarkdownFromJS',  // name
                            null,                   // return type
                            ['string'],            // argument types
                            [gistMarkdown],        // arguments
                            { async: false }       // options
                        );
                        console.log('=== ccall completed, result:', result, '===');
                        document.getElementById('status').textContent = 'Running from gist - Press ESC to quit';
                        console.log('=== Successfully loaded gist content ===');
                    } else if (typeof Module._loadMarkdownFromJS === 'function') {
                        // Fallback: manually allocate string in WASM memory
                        console.log('Using manual string allocation');
                        var len = Module.lengthBytesUTF8(gistMarkdown) + 1;
                        var strPtr = Module._malloc(len);
                        Module.stringToUTF8(gistMarkdown, strPtr, len);
                        Module._loadMarkdownFromJS(strPtr);
                        Module._free(strPtr);
                        document.getElementById('status').textContent = 'Running from gist - Press ESC to quit';
                        console.log('Successfully loaded gist content');
                    } else {
                        console.error('Module.ccall and Module._loadMarkdownFromJS not available');
                        console.log('Available Module functions:', Object.keys(Module).filter(k => k.startsWith('_')));
                        document.getElementById('status').textContent = 'Running (gist load failed) - Press ESC to quit';
                    }
                } catch (e) {
                    console.error('Error loading gist markdown:', e);
                    console.error('Stack trace:', e.stack);
                    document.getElementById('status').innerHTML = '<span class="error">Error loading gist</span>';
                }
            }
        }
        
        var Module = {
            waitingForGist: gistId ? true : false,  // Critical: Set BEFORE WASM initializes
            canvas: document.getElementById('canvas'),
            printErr: function(text) {
                console.error(text);
                document.getElementById('status').innerHTML = '<span class="error">' + text + '</span>';
            },
            print: function(text) {
                console.log(text);
            },
            preRun: [
                function() {
                    // This runs BEFORE the main() function
                    if (gistId) {
                        console.log('PreRun: Setting wait flag for gist');
                        // Set the flag directly in WASM memory if possible
                        // We'll call the function after symbols are available
                    }
                }
            ],
            onRuntimeInitialized: function() {
                moduleReady = true;
                
                // Call setWaitingForGist IMMEDIATELY if gist is present
                // This must happen before initApp runs
                if (gistId && typeof Module._setWaitingForGist === 'function') {
                    console.log('Setting wait flag for gist before app init');
                    try {
                        Module._setWaitingForGist();
                    } catch (e) {
                        console.error('Error calling setWaitingForGist:', e);
                    }
                }
                
                console.log('SDL3 with native TTF rendering initialized');
                
                // Set up aspect ratio-preserving resize
                setupAspectRatioResize();
                
                // Try loading gist if it's ready
                if (gistId) {
                    tryLoadGist();
                } else {
                    document.getElementById('status').textContent = 'Running - Press ESC to quit';
                }
            }
        };
        
        // Fetch gist if specified
        if (gistId) {
            document.getElementById('status').textContent = 'Loading gist ' + gistId + '...';
            
            fetch('https://api.github.com/gists/' + gistId)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Gist not found (HTTP ' + response.status + ')');
                    }
                    return response.json();
                })
                .then(function(gist) {
                    // Find first .md file in gist
                    var mdFile = null;
                    for (var filename in gist.files) {
                        if (filename.endsWith('.md')) {
                            mdFile = gist.files[filename];
                            break;
                        }
                    }
                    
                    if (mdFile) {
                        console.log('Found markdown file in gist:', mdFile.filename, '(' + mdFile.content.length + ' bytes)');
                        gistMarkdown = mdFile.content;
                        gistReady = true;
                        document.getElementById('status').textContent = 'Loaded ' + mdFile.filename + ', starting...';
                        
                        console.log('Module ready:', moduleReady, 'Gist ready:', gistReady);
                        
                        // Try loading gist if module is ready
                        tryLoadGist();
                    } else {
                        throw new Error('No .md file found in gist');
                    }
                })
                .catch(function(error) {
                    console.error('Error loading gist:', error);
                    document.getElementById('status').innerHTML = '<span class="error">Error: ' + error.message + '</span>';
                    gistMarkdown = null;
                });
        }
        
        function setupAspectRatioResize() {
            const canvas = Module.canvas;
            const initialWidth = canvas.width;
            const initialHeight = canvas.height;
            const aspectRatio = initialWidth / initialHeight;
            
            console.log('Initial canvas size:', initialWidth, 'x', initialHeight);
            console.log('Target aspect ratio:', aspectRatio);
            
            function resizeCanvas() {
                const container = document.getElementById('container');
                const statusHeight = 40; // Reserve space for status text
                
                let maxWidth = window.innerWidth;
                let maxHeight = window.innerHeight - statusHeight;
                
                let newWidth, newHeight;
                
                const windowAspect = maxWidth / maxHeight;
                
                if (windowAspect > aspectRatio) {
                    // Window is wider - limit by height
                    newHeight = maxHeight;
                    newWidth = newHeight * aspectRatio;
                } else {
                    // Window is taller - limit by width
                    newWidth = maxWidth;
                    newHeight = newWidth / aspectRatio;
                }
                
                // Update canvas display size (CSS scaling)
                canvas.style.width = Math.floor(newWidth) + 'px';
                canvas.style.height = Math.floor(newHeight) + 'px';
                
                console.log('Canvas scaled to:', Math.floor(newWidth), 'x', Math.floor(newHeight));
            }
            
            // Initial resize
            resizeCanvas();
            
            // Resize on window resize
            window.addEventListener('resize', resizeCanvas);
            
            // Also handle orientation changes on mobile
            window.addEventListener('orientationchange', function() {
                setTimeout(resizeCanvas, 100);
            });
        }
    </script>
    <script src="storie.js"></script>
</body>
</html>